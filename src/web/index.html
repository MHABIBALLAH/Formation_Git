<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComptaAI</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f7f6; color: #333; }
        .container { width: 100%; height: 100vh; display: flex; flex-direction: column; }
        .auth-wrapper { flex-grow: 1; display: flex; justify-content: center; align-items: center; }
        .auth-container { max-width: 400px; width: 100%; margin: auto; padding: 2em; background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .auth-container h2 { text-align: center; color: #2a7a7b; }
        .form-group { margin-bottom: 1.5em; }
        .form-group label { display: block; margin-bottom: 0.5em; font-weight: bold; }
        .form-group input { width: 100%; padding: 0.8em; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { display: inline-block; background-color: #2a7a7b; color: white; padding: 0.6em 1em; border: none; border-radius: 5px; text-decoration: none; font-weight: bold; text-align: center; cursor: pointer; font-size: 0.9em; }
        .btn:hover { background-color: #236667; }
        .btn[disabled] { background-color: #ccc; cursor: not-allowed; }
        .toggle-link { text-align: center; margin-top: 1em; }
        .toggle-link a { color: #2a7a7b; text-decoration: none; cursor: pointer; }
        .message { padding: 0.5em; margin-top: 1em; text-align: center; border-radius: 4px; }
        .message.error { color: #d9534f; background-color: #f2dede; }
        .message.success { color: #3c763d; background-color: #dff0d8; }
        header { background-color: #2a7a7b; color: white; padding: 1em 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 1.5em; }
        .main-content-area { padding: 2em; overflow-y: auto; flex-grow: 1; }
        h2.page-title { color: #2a7a7b; }
        .hidden { display: none; }
        nav { display: flex; align-items: center; }
        nav a.nav-link { color: white; text-decoration: none; font-weight: bold; margin-right: 1.5em; }
        .user-menu { position: relative; }
        .user-menu-trigger { cursor: pointer; font-weight: bold; }
        .dropdown-menu { position: absolute; top: 100%; right: 0; background-color: white; border-radius: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); list-style: none; padding: 0.5em 0; margin: 0.5em 0 0; min-width: 180px; z-index: 1000; display: none; }
        .user-menu:hover .dropdown-menu, .dropdown-menu.active { display: block; }
        .dropdown-menu a, .dropdown-menu button { display: block; width: 100%; text-align: left; padding: 0.75em 1.5em; color: #333; text-decoration: none; background: none; border: none; cursor: pointer; font-size: 1em; box-sizing: border-box; }
        .dropdown-menu a:hover, .dropdown-menu button:hover { background-color: #f4f7f6; }
        .dropdown-divider { height: 1px; background-color: #eee; margin: 0.5em 0; }
        .card { background-color: white; border: 1px solid #ddd; border-radius: 8px; padding: 1.5em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5em; margin-top: 2em; }
        .card h3 { margin-top: 0; font-size: 1em; color: #666; }
        .card .value { font-size: 2.2em; font-weight: bold; color: #2a7a7b; margin: 0.5em 0 0 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; background-color: white; }
        th, td { text-align: left; padding: 0.8em; border-bottom: 1px solid #ddd; }
        th { background-color: #e9ecef; }
        tr:hover { background-color: #f4f7f6; }
    </style>
</head>
<body>
    <div id="app-container" class="container">
        <div id="loading-view"><p style="text-align: center;">Chargement...</p></div>
        <div id="auth-view" class="hidden auth-wrapper"><!-- Auth HTML --></div>
        <div id="main-app-view" class="hidden">
            <header>
                <h1>ComptaAI</h1>
                <nav>
                    <a href="#" id="nav-dashboard-link" class="nav-link">Tableau de Bord</a>
                    <a href="#" id="nav-invoices-link" class="nav-link">Factures</a>
                    <a href="#" id="nav-cashflow-link" class="nav-link">Flux de Trésorerie</a>
                    <a href="#" id="nav-vat-link" class="nav-link">TVA</a>
                    <div class="user-menu"><!-- User Menu HTML --></div>
                </nav>
            </header>
            <main id="main-content-area" class="main-content-area">
                <div id="dashboard-view" class="hidden"><!-- Dashboard HTML --></div>
                <div id="profile-view" class="hidden"><!-- Profile HTML --></div>
                <div id="invoices-view" class="hidden"><!-- Invoices HTML --></div>
                <div id="cashflow-view" class="hidden"><!-- Cashflow HTML --></div>
                <div id="vat-view" class="hidden"><!-- VAT HTML --></div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const views={loading:document.getElementById('loading-view'),auth:document.getElementById('auth-view'),main:document.getElementById('main-app-view'),dashboard:document.getElementById('dashboard-view'),profile:document.getElementById('profile-view'),invoices:document.getElementById('invoices-view'),cashflow:document.getElementById('cashflow-view'),vat:document.getElementById('vat-view')};
            const authForms={login:document.getElementById('login-form'),register:document.getElementById('register-form'),loginContainer:document.getElementById('login-form-container'),registerContainer:document.getElementById('register-form-container'),showRegisterLink:document.getElementById('show-register-link'),showLoginLink:document.getElementById('show-login-link'),loginError:document.getElementById('login-error'),registerMessage:document.getElementById('register-message')};
            const nav={logoutBtn:document.getElementById('logout-btn'),userMenuTrigger:document.getElementById('user-menu-trigger'),dashboardLink:document.getElementById('nav-dashboard-link'),invoicesLink:document.getElementById('nav-invoices-link'),cashflowLink:document.getElementById('nav-cashflow-link'),vatLink:document.getElementById('nav-vat-link'),profileLink:document.getElementById('nav-profile-link')};
            const profilePage={username:document.getElementById('profile-username'),role:document.getElementById('profile-role'),form:document.getElementById('change-password-form'),message:document.getElementById('change-password-message')};
            const invoicesPage={form:document.getElementById('upload-invoice-form'),fileInput:document.getElementById('invoice-file'),list:document.getElementById('invoices-list'),message:document.getElementById('upload-message')};
            const cashflowPage={form:document.getElementById('cashflow-filter-form'),inflows:document.getElementById('total-inflows'),outflows:document.getElementById('total-outflows'),balance:document.getElementById('net-balance')};
            const vatPage={form:document.getElementById('vat-filter-form'),list:document.getElementById('vat-reports-list')};
            const state={currentUser:null,cashflowPollingTimer:null};
            const api={get:url=>fetch(url).then(r=>r.ok?r.json():Promise.reject(r)),post:(url,body)=>fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json().then(data=>({ok:r.ok,data}))),upload:(url,formData)=>fetch(url,{method:'POST',body:formData}).then(r=>r.json().then(data=>({ok:r.ok,data})))};
            const showMessage=(el,txt,isSuccess)=>{el.textContent=txt;el.className='message';el.classList.add(isSuccess?'success':'error');el.classList.remove('hidden');};
            const hideMessage=el=>el.classList.add('hidden');
            const switchTopView=view=>Object.values(views).slice(0,3).forEach(v=>v===view?v.classList.remove('hidden'):v.classList.add('hidden'));
            const renderers={invoices:invoices=>{invoicesPage.list.innerHTML='';if(invoices.length===0){invoicesPage.list.innerHTML='<tr><td colspan="6" style="text-align:center;">Aucune facture.</td></tr>';return;}
            invoices.forEach(inv=>{const r=document.createElement('tr');const btn=inv.status==='completed'?`<button class="btn btn-validate" data-invoice-id="${inv.id}">Valider</button>`:`<button class="btn" disabled>${inv.status}</button>`;r.innerHTML=`<td>${inv.filename}</td><td>${inv.supplier||'N/A'}</td><td>${inv.invoice_date||'N/A'}</td><td>${inv.total_ttc||'0.00'} €</td><td id="status-${inv.id}">${inv.status}</td><td>${btn}</td>`;invoicesPage.list.appendChild(r);});},cashflow:data=>{cashflowPage.inflows.textContent=`${data.total_inflows.toFixed(2)} €`;cashflowPage.outflows.textContent=`${data.total_outflows.toFixed(2)} €`;cashflowPage.balance.textContent=`${data.net_balance.toFixed(2)} €`;},vatReports:reports=>{vatPage.list.innerHTML='';if(reports.length===0){vatPage.list.innerHTML='<tr><td colspan="5" style="text-align:center;">Aucun rapport.</td></tr>';return;}
            reports.forEach(rec=>{const r=document.createElement('tr');r.innerHTML=`<td>${rec.period_key}</td><td>${rec.total_collected_vat} €</td><td>${rec.total_deductible_vat} €</td><td>${rec.vat_due} €</td><td>${rec.status}</td>`;vatPage.list.appendChild(r);});}};
            const actions={stopCashflowPolling:()=>{if(state.cashflowPollingTimer){clearInterval(state.cashflowPollingTimer);state.cashflowPollingTimer=null;}},startCashflowPolling:fetchFn=>{actions.stopCashflowPolling();state.cashflowPollingTimer=setInterval(fetchFn,5000);},checkAuth:()=>{api.get('/api/auth/profile').then(user=>{state.currentUser=user;nav.userMenuTrigger.textContent=user.username;switchTopView(views.main);actions.showDashboard();}).catch(()=>{state.currentUser=null;actions.stopCashflowPolling();switchTopView(views.auth);});},showDashboard:()=>{switchContentView(views.dashboard);api.get('/api/summary').catch(()=>actions.checkAuth());},showInvoices:()=>{switchContentView(views.invoices);api.get('/api/invoices').then(renderers.invoices).catch(()=>invoicesPage.list.innerHTML='<tr><td colspan="6" style="text-align:center;color:red;">Erreur.</td></tr>');},showProfile:()=>{switchContentView(views.profile);api.get('/api/auth/profile').then(user=>{profilePage.username.textContent=user.username;profilePage.role.textContent=user.role;}).catch(()=>actions.checkAuth());},showCashflow:()=>{switchContentView(views.cashflow);const fetchAndRender=()=>{const sd=cashflowPage.form.elements['start-date'].value,ed=cashflowPage.form.elements['end-date'].value;const p=new URLSearchParams();if(sd)p.append('start_date',sd);if(ed)p.append('end_date',ed);const q=p.toString();api.get(`/api/cashflow${q?'?'+q:''}`).then(renderers.cashflow).catch(()=>renderers.cashflow({total_inflows:0,total_outflows:0,net_balance:0}));};fetchAndRender();actions.startCashflowPolling(fetchAndRender);},showVatReports:()=>{switchContentView(views.vat);const sd=vatPage.form.elements['vat-start-date'].value,ed=vatPage.form.elements['vat-end-date'].value;const p=new URLSearchParams();if(sd)p.append('start_date',sd);if(ed)p.append('end_date',ed);const q=p.toString();api.get(`/api/vat/reports${q?'?'+q:''}`).then(renderers.vatReports).catch(()=>vatPage.list.innerHTML='<tr><td colspan="5" style="text-align:center;color:red;">Erreur.</td></tr>');},};
            const switchContentView=view=>{actions.stopCashflowPolling();Object.values(views).slice(3).forEach(v=>v===view?v.classList.remove('hidden'):v.classList.add('hidden'));};
            authForms.showRegisterLink.addEventListener('click',()=>{authForms.loginContainer.classList.add('hidden');authForms.registerContainer.classList.remove('hidden');});
            authForms.showLoginLink.addEventListener('click',()=>{authForms.registerContainer.classList.add('hidden');authForms.loginContainer.classList.remove('hidden');});
            authForms.login.addEventListener('submit',e=>{e.preventDefault();hideMessage(authForms.loginError);api.post('/api/auth/login',{username:e.target.elements['login-username'].value,password:e.target.elements['login-password'].value}).then(({ok,data})=>ok?actions.checkAuth():showMessage(authForms.loginError,data.error,!1));});
            authForms.register.addEventListener('submit',e=>{e.preventDefault();hideMessage(authForms.registerMessage);api.post('/api/auth/register',{username:e.target.elements['register-username'].value,password:e.target.elements['register-password'].value}).then(({ok,data})=>{if(ok){showMessage(authForms.registerMessage,'Inscription réussie!',!0);authForms.showLoginLink.click();}else showMessage(authForms.registerMessage,data.error,!1);});});
            nav.logoutBtn.addEventListener('click',()=>{api.post('/api/auth/logout').finally(()=>actions.checkAuth());});
            nav.dashboardLink.addEventListener('click',e=>{e.preventDefault();actions.showDashboard();});
            nav.invoicesLink.addEventListener('click',e=>{e.preventDefault();actions.showInvoices();});
            nav.profileLink.addEventListener('click',e=>{e.preventDefault();actions.showProfile();});
            nav.cashflowLink.addEventListener('click',e=>{e.preventDefault();actions.showCashflow();});
            nav.vatLink.addEventListener('click',e=>{e.preventDefault();actions.showVatReports();});
            profilePage.form.addEventListener('submit',e=>{e.preventDefault();hideMessage(profilePage.message);api.post('/api/auth/change-password',{old_password:e.target.elements['old-password'].value,new_password:e.target.elements['new-password'].value}).then(({ok,data})=>{showMessage(profilePage.message,data.message||data.error,ok);if(ok)profilePage.form.reset();});});
            invoicesPage.form.addEventListener('submit',e=>{e.preventDefault();hideMessage(invoicesPage.message);const file=invoicesPage.fileInput.files[0];if(!file){showMessage(invoicesPage.message,'Veuillez sélectionner un fichier.',!1);return;}const fd=new FormData();fd.append('file',file);api.upload('/api/invoices/upload',fd).then(({ok,data})=>{showMessage(invoicesPage.message,data.message||data.error,ok);if(ok){invoicesPage.form.reset();actions.showInvoices();}});});
            invoicesPage.list.addEventListener('click',e=>{if(e.target?.classList.contains('btn-validate')){const btn=e.target,id=btn.dataset.invoiceId;btn.disabled=!0;btn.textContent='...';api.post(`/api/invoices/${id}/validate`).then(({ok})=>{if(ok){document.getElementById(`status-${id}`).textContent='validated';btn.textContent='Validé';}else{btn.disabled=!1;btn.textContent='Valider';}}).catch(()=>{btn.disabled=!1;btn.textContent='Valider';});}});
            cashflowPage.form.addEventListener('submit',e=>{e.preventDefault();actions.showCashflow();});
            vatPage.form.addEventListener('submit',e=>{e.preventDefault();actions.showVatReports();});
            actions.checkAuth();
        });
    </script>
</body>
</html>
